--------------------------------------------------------
--  DDL for Package Body PKG_REPORTES
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE BODY "PTOVENTA"."PKG_REPORTES" is
  FUNCTION FN_LISTA_KARDEX(A_FCH_INICIO VARCHAR2, A_FCH_FIN VARCHAR2) RETURN SYS_REFCURSOR IS
    C_CURSOR SYS_REFCURSOR;
  BEGIN
    SP_CARGA_KARDEX(A_FCH_INICIO , A_FCH_FIN );
    OPEN C_CURSOR FOR
    SELECT * FROM TT_REPO_KARDEX_PROD ;
--    COMMIT;
    RETURN C_CURSOR;

  END;
PROCEDURE SP_CARGA_KARDEX(A_FCH_INICIO VARCHAR2, A_FCH_FIN VARCHAR2)
  AS

CURSOR C_DATOS IS
SELECT * FROM LGT_PROD
WHERE COD_PROD IN (
'100012','100016','102661','103092','110550','111685','111692','112248','114665',
'115047','115048','115685','115763','116764','116765','116766','116767','116853',
'117474','119247','119248','119283','119856','120163','120165','120365','120366',
'120367','120459','120774','120778','121070','121134','121135','121136','121143',
'121148','123246','123247','123600','123823','123955','124026','124218','124221',
'126042','126051','126059','126066','126086','126293','130116','130118','130120',
'130121','130157','130236','130305','130314','130317','130320','130323','130326',
'130329','130331','130394','130396','130398','130400','130402','130526','130664',
'131021','131047','131053','131226','131228','131257','131383','131386','131752',
'132254','132261','132363','132474','132509','132667','132669','132671','132679',
'132684','132690','132693','132765','133072','133075','133256','133402','133403',
'133404','133407','133570','133763','134000','134006','134211','134216','134270',
'134272','134418','134589','134591','134663','134664','134665','135051','135055',
'135134','135137','135141','135146','135262','135265','135270','135272','135290',
'135295','135308','135311','135342','135344','135447','135450','135453','135497',
'135500','135503','135507','135512','135553','135630','135637','135646','135787',
'135840','135845','135848','135856','135858','135862','135878','135890','135909',
'135911','135912','135919','135925','136028','136031','136032','136070','136074',
'136077','136080','136084','136106','136135','136145','136155','136442','136537',
'136736','136763','136948','136964','137030','137033','137035','137581','137582',
'137723','137725','138046','138054','138055','138410','138411','138602','138810',
'138814','138975','138977','139616','139617','139618','139619','139722','140362',
'140412','140609','140658','140659','140702','140703','140704','141035','141073',
'141269','141286','141326','141331','141334','141339','141504','141507','141583',
'141584','142066','153459','155112','155113','156920','157721','158628','161179',
'163575','163578','163579','163590','163608','164242','166485','167951','169922',
'171780','171884','172871','174893','175651','175652','177664','178212','178213',
'180007','184243','184244','185137','187460','187481','190578','200911','200913',
'200914','201496','203626','206777','504225','504326','510164','510179','510203',
'510240','510241','510244','510279','510655','510905','510906','511146','511171',
'511283','511313','511316','511383','511467','511468','511542','511599','511721',
'511722','511723','511725','511926','511935','511936','511945','512501','512502',
'512549','512677','512716','513105','513107','513108','513109','513115','513116',
'513234','513393','513472','513825','513826','513838','513839','513885','513943',
'514055','514056','514057','514114','514138','514367','514368','514621','514622',
'514864','514865','514928','515155','515159','515160','515185','515186','515517',
'515525','515528','515644','515679','515805','534431','534446','537340','537341',
'570018','570031','570060','570070','570122','570292','570419','570577','570641',
'570751','571056','571235','571503','571639','571698','571699','572014','572051',
'572053','572068','572070','572345','572346','572610','572623','572624','572629',
'572636','572637','572644','572655','572656','572663','572668','572669','572700',
'573613','573657','574211','574222','574322','574503','577372','578044','578049',
'578050','578053'
);
BEGIN
    FOR REG IN C_DATOS LOOP
INSERT INTO TT_REPO_KARDEX_PROD
SELECT RR.COD_PROD,
       RR.DESC_PROD||' '||rr.desc_unid_present producto,
       stk_inicial,
       INGRESO,
       SALIDA,
       ((stk_inicial+INGRESO)-SALIDA) SaldoActual
FROM (
select COD_PROD,
       MAX(decode(rownum,1,stk_anterioR_prod,0)) stk_inicial,
        SUM(CASE WHEN CANT_MOV_PROD>0 THEN CANT_MOV_PROD ELSE 0 END) INGRESO,
        SUM(CASE WHEN CANT_MOV_PROD<0 THEN CANT_MOV_PROD*-1 ELSE 0 END) SALIDA

from (
select *
from lgt_kardex
where fec_kardex>= to_date(A_FCH_INICIO,'dd/mm/yyyy')
and  fec_kardex< to_date( A_FCH_FIN,'dd/mm/yyyy')+1
and cod_prod=REG.COD_PROD
order by cod_prod, fec_kardex
) ff
GROUP BY COD_PROD
) KK, LGT_PROD RR
WHERE KK.COD_PROD = RR.COD_PROD;
END LOOP;
END;

END;

/
